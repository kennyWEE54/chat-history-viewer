<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>聊天记录查看 | 按手机号查询</title>
  <style>
    :root{--bg:#0b0c0f;--card:#111318;--muted:#9aa3b2;--soft:#1a1d24;--brand:#4f8cff;--user:#eef1f5;--assistant:#e9f1ff;--radius:16px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#e6e9ef;background:
      radial-gradient(1200px 600px at 70% -10%,#1a3d7a33,transparent 60%),
      radial-gradient(900px 400px at 10% 10%,#2f5bdd22,transparent 60%),var(--bg)}
    .app{max-width:960px;margin:32px auto;padding:0 16px 32px}
    .card{background:linear-gradient(180deg,#141722 0%,#0f1218 100%);border:1px solid #1f2530;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.45);overflow:hidden}
    .header{padding:20px;border-bottom:1px solid #1c2230;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end;background:linear-gradient(180deg,rgba(79,140,255,.08),transparent)}
    .title{font-size:16px;font-weight:700}
    .profile{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:#182036;border:1px solid #2a3248;color:#c9d4ff;padding:4px 10px;border-radius:999px;font-size:12px}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .search{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .input{background:var(--soft);border:1px solid #2a3240;border-radius:12px;height:40px;padding:0 12px;color:#e6e9ef;outline:none;width:360px}
    .input::placeholder{color:#6b7687}
    .btn{height:40px;padding:0 14px;border-radius:12px;border:1px solid #2a3240;background:linear-gradient(180deg,#2a65ff,#1d49c9);color:#fff;font-weight:600;letter-spacing:.2px;cursor:pointer}
    .content{padding:14px}
    .meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;padding:6px 8px 8px}
    .messages{padding:6px;display:flex;flex-direction:column;gap:8px;max-height:62vh;overflow:auto}
    .msg{display:flex;gap:8px;align-items:flex-end}
    .user .bubble{background:var(--user);color:#111318;border-top-left-radius:6px}
    .assistant{justify-content:flex-end}
    .assistant .bubble{background:var(--assistant);color:#0a1020;border-top-right-radius:6px}
    .bubble{max-width:min(80%,760px);padding:10px 12px;border-radius:var(--radius);white-space:pre-wrap;box-shadow:0 8px 18px rgba(0,0,0,.22)}
    .stamp{color:var(--muted);font-size:11px;margin:2px 6px;max-width:80%}
    .user .stamp{text-align:left} .assistant .stamp{text-align:right}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">聊天记录查看</div>
          <div class="profile">
            <span class="pill" id="u_name">—</span>
            <span class="pill" id="u_nickname">—</span>
            <span class="pill" id="u_birthdate">—</span>
          </div>
          <div class="sub">输入手机号，查看该用户与助手的历史对话</div>
        </div>
        <form id="searchForm" class="search" action="#" method="GET">
          <input id="phone" name="phone" class="input" type="tel" placeholder="例如：601114014090（只输入数字）" />
          <button id="btn" class="btn" type="submit" aria-label="查询">查询</button>
        </form>
      </div>

      <div class="content">
        <div class="meta">
          <span id="who">未查询</span>
          <span id="summary">—</span>
        </div>
        <div id="list" class="messages">
          <div class="stamp">👆 请输入手机号后点击「查询」</div>
        </div>

        <!-- 分页控制 -->
        <div id="pager" style="display:flex;justify-content:center;gap:10px;margin-top:10px;padding:8px 0;">
          <button id="prevBtn" class="btn" type="button" disabled>上一页</button>
          <button id="nextBtn" class="btn" type="button" disabled>下一页</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 改成你的 Supabase Edge Function JSON API
    const API_URL = 'https://lxklyjkguvjqysjyzemh.functions.supabase.co/chat-history';

    // 分页参数
    const PAGE_SIZE = 150;    // 每页多少条
    let currentOffset = 0;   // 当前偏移

    const $ = (s) => document.querySelector(s);
    const norm = (v) => (v||'').replace(/[^\d]/g,'');
    const fmt = (ts) => { try{ const d=new Date(ts);
      const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'),
            hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${dd} ${hh}:${mm}`; }catch{ return ts||'' } };

    // 规范化号码：01 开头（马来西亚本地）自动补 60
    const normalizeMsisdn = (d) => {
      if (!d) return d;
      return /^01\d{8,9}$/.test(d) ? '6' + d : d;
    };

    // 读取 ?phone=... 方便外部直连
    function getQueryParam(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name) || '';
    }

    async function load(phone, offset = 0){
      const qs = new URLSearchParams({
        phone,
        limit: String(PAGE_SIZE),
        offset: String(offset),
        since_hours: '876000'   // 100 年，规避后端 created_at 过滤
      }).toString();
      const res = await fetch(`${API_URL}?${qs}`, { headers:{accept:'application/json'}, cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      return { messages: data.messages||[], user: data.user||null, total: data.total||0, params: data.params||{} };
    }

    function render(phone, rows, user){
      $('#u_name').textContent = user?.name ?? '—';
      $('#u_nickname').textContent = user?.nickname ?? '—';
      $('#u_birthdate').textContent = user?.birthdate ?? '—';
      $('#who').textContent = rows.length ? `手机号：${phone}` : '未查询 / 无结果';

      const list = $('#list');
      list.innerHTML = '';
      if(!rows.length){ list.innerHTML = '<div class="stamp">😶 没有找到聊天记录</div>'; return; }

      for(const m of rows){
        const side = m.role === 'assistant' ? 'assistant' : 'user';
        const msg = document.createElement('div');
        msg.className = 'msg '+side;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = m.content || '';
        msg.appendChild(bubble);
        list.appendChild(msg);

        const stamp = document.createElement('div');
        stamp.className = 'stamp '+side;
        stamp.textContent = `${m.role||''} · ${fmt(m.created_at)}`;
        list.appendChild(stamp);
      }
      list.scrollTop = list.scrollHeight;
    }

    async function onQuery(offset = 0){
      const phone = normalizeMsisdn(norm($('#phone').value));
      if(!phone){ alert('请输入手机号（仅数字）'); return; }
      $('#who').textContent = `手机号：${phone}`;
      $('#summary').textContent = '加载中…';
      $('#list').innerHTML = '<div class="stamp">⌛ 加载中…</div>';
      try{
        const {messages,user,total} = await load(phone, offset);
        render(phone, messages, user);
        // 更新 summary 与按钮状态
        const pageNo = Math.floor(offset / PAGE_SIZE) + 1;
        const pageMax = Math.max(1, Math.ceil(total / PAGE_SIZE));
        $('#summary').textContent = `共 ${total} 条消息 · 第 ${pageNo}/${pageMax} 页`;
        $('#prevBtn').disabled = offset <= 0;
        $('#nextBtn').disabled = offset + PAGE_SIZE >= total;
        currentOffset = offset;
      }catch(e){
        $('#list').innerHTML = '<div class="stamp">❌ 拉取失败，请稍后重试</div>';
        console.warn(e);
      }
    }
    document.getElementById('searchForm').addEventListener('submit', (e) => {
      e.preventDefault();
      onQuery(0);
    });
    document.getElementById('phone').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); onQuery(0); }
    });

    // 分页按钮
    document.getElementById('prevBtn').addEventListener('click', () => onQuery(Math.max(0, currentOffset - PAGE_SIZE)));
    document.getElementById('nextBtn').addEventListener('click', () => onQuery(currentOffset + PAGE_SIZE));

    // 页面加载时，支持 ?phone=6011... 直达查询
    (function initFromQuery(){
      const p = normalizeMsisdn(norm(getQueryParam('phone')));
      if(p){
        const input = document.getElementById('phone');
        input.value = p;
        // 直接查询
        onQuery(0);
      }
    })();
  </script>
</body>
</html>
